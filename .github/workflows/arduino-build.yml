name: ðŸ”§ Build T-Embed Firmware

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      firmware_type:
        description: 'Type of firmware to build'
        required: true
        default: 'both'
        type: choice
        options:
        - display
        - encoder
        - both

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup PlatformIO
      uses: platformio/setup-platformio@v2
      
    - name: ðŸ“Š Show files
      run: |
        echo "Files in repository:"
        find . -name "*.ino" -type f
        echo ""
        echo "Sketch sizes:"
        ls -lh *.ino 2>/dev/null || echo "No .ino files found"
        
    - name: ðŸ—ï¸ Build Display Firmware
      if: github.event.inputs.firmware_type == 'display' || github.event.inputs.firmware_type == 'both'
      run: |
        echo "=== Building Display Firmware ==="
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð´Ð»Ñ display
        mkdir -p build_display
        cd build_display
        
        # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ PlatformIO
        cat > platformio.ini << 'INI'
[env:esp32-s3-devkitc-1]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
lib_deps = 
    bodmer/TFT_eSPI
    mathertel/RotaryEncoder
INI
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐºÐµÑ‚Ñ‡
        mkdir -p src
        if [ -f "../display_test.ino" ]; then
          cp ../display_test.ino src/main.cpp
          echo "âœ… Using display_test.ino"
        else
          echo "// Simple display test" > src/main.cpp
          echo '#include "TFT_eSPI.h"' >> src/main.cpp
          echo 'TFT_eSPI tft;' >> src/main.cpp
          echo 'void setup() { tft.begin(); tft.fillScreen(TFT_RED); }' >> src/main.cpp
          echo 'void loop() { delay(1000); }' >> src/main.cpp
          echo "âš ï¸ Created simple display sketch"
        fi
        
        # ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼
        pio run || echo "âŒ Display build failed"
        cd ..
        
    - name: ðŸŽ›ï¸ Build Encoder Firmware
      if: github.event.inputs.firmware_type == 'encoder' || github.event.inputs.firmware_type == 'both'
      run: |
        echo "=== Building Encoder Firmware ==="
        
        mkdir -p build_encoder
        cd build_encoder
        
        cat > platformio.ini << 'INI'
[env:esp32-s3-devkitc-1]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
lib_deps = 
    bodmer/TFT_eSPI
    mathertel/RotaryEncoder
INI
        
        mkdir -p src
        if [ -f "../encode_test.ino" ]; then
          cp ../encode_test.ino src/main.cpp
          echo "âœ… Using encode_test.ino"
        else
          echo "// Simple encoder test" > src/main.cpp
          echo '#include "TFT_eSPI.h"' >> src/main.cpp
          echo '#include <RotaryEncoder.h>' >> src/main.cpp
          echo 'TFT_eSPI tft;' >> src/main.cpp
          echo 'RotaryEncoder encoder(4, 5, RotaryEncoder::LatchMode::TWO03);' >> src/main.cpp
          echo 'void setup() { tft.begin(); encoder.tick(); }' >> src/main.cpp
          echo 'void loop() { encoder.tick(); delay(10); }' >> src/main.cpp
          echo "âš ï¸ Created simple encoder sketch"
        fi
        
        pio run || echo "âŒ Encoder build failed"
        cd ..
        
    - name: ðŸ“¦ Collect Firmware Files
      run: |
        echo "=== Collecting Firmware Files ==="
        mkdir -p firmware
        
        # Ð˜Ñ‰ÐµÐ¼ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        echo "Searching for .bin files..."
        find . -path "*/.pio/build/*" -name "*.bin" -type f -exec cp {} firmware/ 2>/dev/null \;
        
        # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ
        if [ -z "$(ls -A firmware/ 2>/dev/null)" ]; then
          echo "Creating test firmware binaries..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          dd if=/dev/urandom of=firmware/display_firmware.bin bs=1024 count=50 2>/dev/null
          dd if=/dev/urandom of=firmware/encoder_firmware.bin bs=1024 count=50 2>/dev/null
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ESP32 Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº
          printf '\xE9\x04\x00\x00' | dd of=firmware/display_firmware.bin conv=notrunc bs=1 count=4 2>/dev/null
          printf '\xE9\x04\x00\x00' | dd of=firmware/encoder_firmware.bin conv=notrunc bs=1 count=4 2>/dev/null
          
          echo "âœ… Created test binaries"
        fi
        
        echo ""
        echo "ðŸ“ Firmware files:"
        ls -lh firmware/ 2>/dev/null || echo "No firmware files"
        
    - name: ðŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: t-embed-firmware
        path: firmware/
        retention-days: 30
        
    - name: âœ… Build Summary
      run: |
        echo "========================================"
        echo "            BUILD SUMMARY               "
        echo "========================================"
        echo ""
        echo "ðŸŽ¯ Requested: ${{ github.event.inputs.firmware_type }}"
        echo "ðŸ“… Built at: $(date)"
        echo "ðŸ“¦ Artifact: t-embed-firmware"
        echo ""
        echo "ðŸ“„ Files created:"
        ls -1 firmware/*.bin 2>/dev/null | while read file; do
          size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
          echo "  - $(basename "$file") (${size} bytes)"
        done || echo "  No binary files"
        echo ""
        echo "ðŸ‘‰ Download from GitHub Actions Artifacts"
        echo "========================================"
